# Used by restore_backup.yml
---
- name: Update dynamic data for VMs on the host used to redeploy
  ansible.builtin.command: >-
    "{{ engine_psql }}" -c
    "UPDATE vm_dynamic SET run_on_vds = NULL, status=0 /* Down */ WHERE run_on_vds IN
    (SELECT vds_id FROM vds WHERE
    upper({{ item.vds_type }})=upper('{{ item.input }}'))"
  environment: "{{ he_cmd_lang }}"
  changed_when: true
  register: db_update_host_vms
- name: Update dynamic data for VMs migrating to the host used to redeploy
  ansible.builtin.command: >-
    "{{ engine_psql }}" -c
    "UPDATE vm_dynamic SET migrating_to_vds = NULL, status=0 /* Down */ WHERE migrating_to_vds IN
    (SELECT vds_id FROM vds WHERE
    upper({{ item.vds_type }})=upper('{{ item.input }}'))"
  environment: "{{ he_cmd_lang }}"
  changed_when: true
  register: db_update_host_migrating_vms
- name: Remove host used to redeploy
  ansible.builtin.command: >-
    "{{ engine_psql }}" -c
    "SELECT deletevds(vds_id) FROM
    (SELECT vds_id FROM vds WHERE
    upper({{ item.vds_type }})=upper('{{ item.input }}')) t"
  environment: "{{ he_cmd_lang }}"
  changed_when: true
  register: db_remove_he_host
